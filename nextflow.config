/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

nextflow.enable.moduleBinaries = true
nextflow.enable.dsl = 2

params {

    // Pipeline parameters
    project_name            = "project"
    outdir                  = "${baseDir}"
    input_seurat_object     = "${baseDir}/data/non_tumor_batchcorrected.rds"
    nichenet_assets_dir     = "${baseDir}/assets/nichenet_resources/"

    // Core metadata
    organism                = "human"        // human|mouse
    assay                   = "RNA"
    slot                    = "data"
    celltype_col            = "celltype"
    sample_col              = "sample_id"
    condition_col           = "condition"

    // Filtering
    min_cells_per_group     = 30

    // LIANA
    liana_resource          = "consensus"
    liana_top_n_plot        = 300
 
    // deterministic 'known locations' produced by the pipeline
    liana_csv    = "${params.outdir}/${params.project_name}/cellcommunication/liana/data/liana_results.csv"
    cellchat_rds = "${params.outdir}/${params.project_name}/cellcommunication/cellchat/data/cellchat_object.rds"



    // NicheNet defaults (AUTO)
    receiver_mode           = "auto"          // auto|manual
    sender_mode             = "auto_top_outgoing" // auto_top_outgoing|all_other|manual
    auto_k_receivers        = 3
    auto_m_senders          = 5
    manual_receivers        = "CD8 T"
    manual_senders          = "Mono,DC,Fibroblast"

    // contrast
    condition_ref           = "Control"
    condition_test          = "Case"

    // DE thresholds
    logfc_min               = 0.25
    padj_max                = 0.05
    max_geneset             = 300

    // NicheNet viz
    top_ligands             = 30
    heatmap_ligands         = 15
    heatmap_targets_per_ligand = 40

    // Notebooks (QMD)
    liana_qmd    = "${baseDir}/modules/local/Cell_Communication/LIANA/Run_LIANA.qmd"
    cellchat_qmd = "${baseDir}/modules/local/Cell_Communication/CellChat/Run_CellChat.qmd"
    nichenet_qmd = "${baseDir}/modules/local/Cell_Communication/NicheNet/Run_NicheNet.qmd"
    report_qmd   = "${baseDir}/modules/local/Cell_Communication/Report_CellComm/Report_CellComm.qmd"


    // Quarto template (optional, keep if you use it elsewhere)
    page_config             = "${baseDir}/assets/template/_quarto.yml"
    template                = "${baseDir}/assets/template/*"

    // Container
    container_cellcomm      = "syedsazaidi/scratch-cellcommunication:latest"

    // Max resource options
    max_cpus                = 16
    max_memory              = '60 GB'
    max_time                = '1000 h'
}

process {
    containerOptions = { getContainerOptions(workflow.containerEngine) }
    stageInMode = 'symlink'

    // Per-step resources (tune)
    withName: CELLCOMM_LIANA    { cpus = 8;  memory = '40 GB';  time = '24 h'  }
    withName: CELLCOMM_CELLCHAT { cpus = 16; memory = '50 GB';  time = '72 h'  }
    withName: CELLCOMM_NICHENET { cpus = 16; memory = '50 GB';  time = '72 h'  }
    withName: CELLCOMM_REPORT   { cpus = 2;  memory = '8 GB';   time = '4 h'   }
}

// =========================
// Helpers
// =========================
def getContainerOptions (executor) {
    if (executor == 'docker') {
        return '-u root:root -e USERID=$UID -e XDG_CACHE_HOME=tmp/quarto_cache_home -e XDG_DATA_HOME=tmp/quarto_data_home -e QUARTO_PRINT_STACK=true'
    } else if (executor == 'singularity') {
        return '--env USERID=$UID --env XDG_CACHE_HOME=tmp/quarto_cache_home --env XDG_DATA_HOME=tmp/quarto_data_home --env QUARTO_PRINT_STACK=true'
    } else {
        return ''
    }
}

// Load nf-core custom profiles from different Institutions (optional)
profiles {
    docker {
        docker.enabled         = true
        docker.fixOwnership    = true
        singularity.enabled    = false
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
    }

    test      { includeConfig 'conf/test.config' }
    seadragon { includeConfig 'conf/institution.config' }
}

// Module configs (stubs allowed)
includeConfig 'conf/modules.config'
includeConfig 'conf/base.config'
